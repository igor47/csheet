[tools]
bun = "1.3.1"
jj = "latest"
dbmate = "2.28.0"
jq = "latest"
pulumi = "3.203.0"

[env]
# Optional: Set default port
PORT = "3000"
GCP_PROJECT = "csheet-475917"
GCP_REGION = "us-central1"
GCR_REPOSITORY = "csheet"
GCR_REGION = "us-central1"
RIPGREP_CONFIG_PATH = "{{config_root}}/.ripgreprc"
SMTP_USER = { age = "YWdlLWVuY3J5cHRpb24ub3JnL3YxCi0+IHNzaC1lZDI1NTE5IEE4UVoyUSBVOVZEUERlZXJ4SGZ6WWtwUnBiUUtHSldQQ3lyMXcrakFYa00xOVkraWlZCi9BRjhrMnJNZWJXUm10MUlQN0NMWndJa2FyOWFQL3dlWEY0ajJHWE5xU2MKLT4gc3NoLXJzYSB1OXJrbUEKamdkZzNjTkhxN1ZiSkl3bk85bStJOUE2aHZuQUJqNFU2eHltcVlSZVppY0szVFd0RXpRWXYvLzFxcmZVL2lLWApjL0tCdGxGQ25mcUVTZHd0TWl2ZDdXSnF4OEpQOEE4aFpLbGIzZ0tRWS9CaXJmbkRsbmtza0hSN2Q4dXNEeExYCitETHdkTXFhUGJNVW54UXpPUUVXQlM3cW41Y3YrMUJWdUV6NnVaZVZxOGZ6T1d6d1gxblFCYmVaR3IwYWJHTTgKZWp5SGNmcHFDK0MxbzhkaXMvR3p5YjFFRTRkRWJmeGF0QkM4S2xhc0hmUTJPWnpkT0lCQ24yVHVzMlZ1dzZKUwo4bWV3UndRTlVSL25welhZdWpwdTlJNjRoQVhTeFZnM2Z0anc5Z0kyYnliUDFWeHMvWGFSa1UweFFLalVQT1A0CkxvNE9BQjJ0aHlCNURqMmdKb2xSNCtZYmcyTGpsZTN2VGMzNFFadUt1OXEyakdlbzJ4S2RMOE1BKzJocmNpdXoKdkk3YnZjK09kS2l5UHNKd0FpeC80QzkzSkg2cE1mZWRURWxORXlTNkw3NG95UHBySFlzSTR2YXBwQkl4Y3dwWAp3YUlJL3ZMa0JpU0VLVWhLNDZ1MkxyNjN1dGNaTVRXcWM4SStTbHpBUE5mbldXL0I3eksweCttVDQwMVZOdnJ0CgotPiA1MUEtZ3JlYXNlIDJVNEl4IgpkNGZQTGtHdmV6dGNGVjRZRk5Ubnd0YXljVWNZNnBrVkllcTIwZDJGRXhtYkcxSlduWTA2SXZ3K3JBSVRMbEsvCmhQSzV1YTRXMzB5VmNQRS9ZRXZITjRReHFFeG5CQQotLS0gR01nd3FZTFlkeGVuZ0xUcTJDWGpYT2NuNHd2ait2Zk4vdUhWMjh6WFNzRQpUvZ3b9cPz2T+0rMYuIKy3KBv4NWi6c9OZMAmqApXCqW11pijXitl6NGk" }
SMTP_PASSWORD = { age = "YWdlLWVuY3J5cHRpb24ub3JnL3YxCi0+IHNzaC1lZDI1NTE5IEE4UVoyUSBrY09FcjdxckRCQ1RCbERveUVhS0twM0lUZEY3N3FCZzUzYllIUUNtdlhVCnFJSmpjY3VSZ1VGb2FHRUFZTEQrOEVWc3pWR0tJenRTV1ZnQjc5ckVRd2MKLT4gc3NoLXJzYSB1OXJrbUEKUW81RmFCVGsyVWUrTTdPWFJaa0trb0R1djloaVpBWEdUYWNENFJ5YzE3dHRGVnpJTUZrUGFZWnhxOW95Z1ZmRwpKblR6WUZ4Ym9NMEY1eEJ5MzFuYWR0SHdwMmZkM3JDTDNkUnFnMlZlb0d2dTIzeHZ5VzRFVWRxcjd4aFR6R1Y0Cjd6cTVLM1ZRZTZEekZMT3RaMHdpdXlCOFllYm56Y1FCanhadTdGNU50c3hSdmNrU2NZaUZjRU5GYnN6N1dNNWsKTnkyMzgxTFdNWFpkM2VCaGtaS1hmZjRBVDhISGJKUEl0SWJwSFVLTzQ3ZUx4VVVCN1ZaTU5pdVdGT2dUVzJRWQpFTjYxc05aMUFjUkNnM05GTS9Ca3lPVXduSFZuYkJlVURRZWdCZ0xCUFpnMDB5SmhobFRQbEtrUWxmQTE4T3orCms0OGdTdm8wdnhkRXEvQ2ljWVRqTWpuaVNGVjdINnQ4OVJEcldVSGRCUTErdzRKKzJXdGVvaUFEdTRhRGJpZDYKcnNSMmtPeko4MnlYV0EzSEZxWWhjOUVZVnFTdHBNeTJYbGxnRStua1BaUVRndC9yRU8vNDgwU2hnSC9HVWFyZwpHeEl1dWFZcS9RU1RvYXpxMTF5WHhlbWxYSEhNcTVuK3F1MTZyd1RQdS8zZVBPckpjMTRwQ2ZMQ0hoUG1SVU9lCgotPiB4SEJFOy1ncmVhc2UgOCk0IFo7aCNrTyB7WkIqSwptWVFjTi9lN0F3Um4KLS0tIFJyTXF5enR4RDdzM2RvWUJicDdpMU9vTU5MTGNvcTR0R3R2NlQyVXNKSmMKDSr0OwFly2cP7MXIBc2eKxh+mcOUpvXGPqMTeb+GGk/TYSE06g/r2Fx0Czw4eFdY" }
SMTP_HOST = { age = "YWdlLWVuY3J5cHRpb24ub3JnL3YxCi0+IHNzaC1lZDI1NTE5IEE4UVoyUSBidUcyUGJ4R2wwS1J3OGcrMlBkZHJoUjFHbHVxU0R5dHAyckkwN1JFRVVVCkw1LzVQdmtYL2szUVVqYWFJK2dJdjVFKzM2VmhiUlNYemN4dnRpcW16c2sKLT4gc3NoLXJzYSB1OXJrbUEKUjVVY1dHT1ZkUndya0toek5URnF4bytBM2NzSk5VdjlwY3Bxb0ZjWEZmRGdlMndzWm12THp0VXFOYkFHQnV6UgorbmxnVUNSZEZQczZGT2kybk5jK3N6NWhCUUw2L0RzZG1qQ3ZrOGV5OHQ1aXZaTXF4M2cwYUhXRHpmZmE3c1Q5Ci9nL2FmdG5hcmxaRVBJTml2YlI2akYrMFhvdFFuTFJ2b0FQWmdnQUlMbjNYb1cvREFjdWRYMThnQ0g1T21MTVgKcjBkVjFjZ1hLcU5Hb3lnYXVxZ3E0U1QyWUN0VjVsYXIyNjNHRHBubjJHWHh5bDd4QXJiTDhWMHdkUk9ZTGpqUQpIMzFJOS84dkI4MHdWUW1KRVZpV0Z1NDI5clpRL0E3c3o0UTlFMCtxbWtnQ3BLQ0UzSnN2V24vWXpEU3l2QWZXCmVkRVBIcUVuTUJlYkdiU3FXcTJ3NGU2YnFhcDVsQUV4NWFiVm1RNm16RnZjRkc0OW1qeVd3ZEN4UTN5MXprYnQKaFNtbEdZZnAwVlFKUS9GOXorbkZ2alp0bmZFUk9OODNBYUxNeWZnbkNoM3NyMmxaYzBBd0M3RDlWcnYzdUQ3RApwd3NxSU5ETTZyUE5YWWZsYklEMUtOWG1PaGpld0JFUTBQSWQ3YkZFZDJtMjF2Um1wZWtCTmZGYXQ4TzlGREF6CgotPiBqUzx9QnJYLWdyZWFzZQphOXVRSTkvdjBwYi9lN3JKYmpYc2FCZVlFUitJN3NxZjBOL1NRc0FUUGwvcXEzVEtNcWlPTnAvNEY2a2gvdnUwClJRMFFQSTdXOGgzZ21aS1hZSjlhTFBRZ1FMN1dLQmQ2Lys0Ci0tLSBDYll1K2FXeWdjcGdFZDRXdU9DY2p5bGtzK2pRUDdGWWErQTlWekRyeCtvClE9GFpXwGGbydc0jtlYEqjcfb0qyDshK38BevjpFRLnk7Uzvr2kLu22kfBWsFDasg" }
SMTP_PORT = { age = "YWdlLWVuY3J5cHRpb24ub3JnL3YxCi0+IHNzaC1lZDI1NTE5IEE4UVoyUSByUzJlRGdDbTRTQlExNUYwakFtTklRc2ZIRC9UV1lKYmd5cUNhUnZzQ2dnClRSTithb0d2UUJYSG0zU08xc0NlZVR0bC9TOWdqU1J6ZEJtN25RUmsrM2cKLT4gc3NoLXJzYSB1OXJrbUEKTWhrLzJSbmpDVWZlc3FEL0NZYXpLd1JWcXVVMjAxeVZxSVhmaVpRQ2tkU3VyY0VZV1ViamRsVmkra3J3VnlOZAphdjFzWkRreUFhU2pVb0w0cTZaTmE1MzBqVkJlV0dSc2JpTk1DUktOMXFSckJ6bS9GQ0lIZ3hYbmJPTUVLMmJsCmtHcmJ2QVdJd0s4TWkyRzRhRjBjWWkzdDV1LzVUY1BsVTdnNlA5bld1NVJqd2d4bnhpTFRtZ3QwU25pUkkrREMKdnFNZy9XdEpvUlVqVGtLZ2hmcU1OSWtOMzJPSHg4OHZFR2lPUFJwQzZiaHdKMy81SGtreWNuamZyRFdKa2EvUwpOWE5OVVRlRzVmRnRzWkNvbzdzQTlHL05ZTGtSTnNFVGUwSkR2TlZORklYTS9FV0VOSkVIRUNNVXRnWWIxNEpLCjNiaVhjdjdCM3g2MVlvTFMwZDNVbFFTYkc4VGVaZ2RCRS9vYnRGMUJITUt1b1lmQVdxZXFFUUNDekV3ZHhTS3oKVEVpOFF3ZVpkMUJCSU85ZXJ5VU53Q3pRSERyNkNlTU8yeGF2U251dy9OMjJmVnJER0l0Q3g5R2xZTzBTWUptNAp3QWF4QkZLWWtBcjNpcXRSa0RKTXM4NFFPOFlkbjJMa0pCNGxmbTBSSFY3RnNjL0ZYUGtMVEFRc3VYNU91dGRKCgotPiB3KS1ncmVhc2UgS34gYyhkYAorMGNRdEdVeTBTd3pyeTBxcDl1cHc1cUc4L0tQSmE0b2FXVkdvRSsxUlNXODk1NFZrbUxEb2ZVT2dTc3lITkJ1Cmp3anRPTGQwM0EKLS0tICtOYlRFaHUzVjFmdjExL3ppQzJONGhrYUdSbVpvK0t4UXY5SjRRTWE5bUkKNow/FeMDs2jMHUZYhFXSgY+wDdhJ+/klW7X+rIm6eWTL/wIS" }

[settings.age]
key_file = "{{config_root}}/age_key_file"

[tasks."app:dev"]
run = "bun run --watch main.ts"
description = "Start development server with hot reload"
depends = ["deps:up", "s3:setup"]

[tasks."app:prod"]
run = "NODE_ENV=production bun run main.ts"
description = "Start production server"

[tasks."app:container"]
run = "docker compose --profile app up --build app"
description = "Build and run the app container alongside local deps"
depends = ["s3:setup"]

[tasks."infra:preview"]
run = "pulumi preview --cwd pulumi/infra \"$@\""
description = "Preview infrastructure changes"

[tasks."infra:up"]
run = "pulumi up --cwd pulumi/infra \"$@\""
description = "Apply infrastructure changes"

[tasks."infra:destroy"]
run = "pulumi destroy --cwd pulumi/infra \"$@\""
description = "Destroy provisioned infrastructure"

[tasks."deploy:push"]
run = """
  set -eu
  SHORT_SHA=$(bin/get-commit-sha.sh)
  IMAGE="us-central1-docker.pkg.dev/${GCP_PROJECT}/${GCR_REPOSITORY}/csheet:${SHORT_SHA}"
  echo "Building image ${IMAGE} for commit ${SHORT_SHA}"
  docker build -t "${IMAGE}" .
  echo "Pushing image ${IMAGE}"
  docker push "${IMAGE}"
  echo ""
  echo "Image pushed successfully!"
  echo "To deploy, run: mise run deploy:up"
"""
description = "Build and push the application image to Artifact Registry (tagged with commit SHA)"

[tasks."deploy:preview"]
run = """
  set -eu
  SHORT_SHA=$(bin/get-commit-sha.sh)
  pulumi preview --cwd pulumi/app --config imageTag=${SHORT_SHA} "$@"
"""
description = "Preview application deployment changes with current commit SHA"

[tasks."deploy:up"]
run = """
  set -eu
  SHORT_SHA=$(bin/get-commit-sha.sh)
  pulumi up --cwd pulumi/app --config imageTag=${SHORT_SHA} "$@"
"""
description = "Deploy the Cloud Run service and migration job with current commit SHA"

[tasks."deploy:destroy"]
run = "pulumi destroy --cwd pulumi/app \"$@\""
description = "Remove the Cloud Run service and migration job"

[tasks."ops:logs"]
run = "gcloud beta run services logs tail prod-app --project=csheet-475917 --region=us-central1"
description = "Tail production Cloud Run logs"

[tasks.install]
run = "bun install"
description = "Install dependencies"

[tasks."deps:up"]
run = "docker compose up --detach --wait"
description = "Start all Docker services (PostgreSQL and MinIO)"

[tasks."deps:down"]
run = "docker compose down"
description = "Stop all Docker services"

[tasks."db:upgrade"]
run = """
  CONFIG=$(bun src/config.ts)
  PG_HOST=$(echo "$CONFIG" | jq -r '.postgresHost')
  PG_PORT=$(echo "$CONFIG" | jq -r '.postgresPort')
  PG_USER=$(echo "$CONFIG" | jq -r '.postgresUser')
  PG_PASSWORD=$(echo "$CONFIG" | jq -r '.postgresPassword')
  PG_DB=$(echo "$CONFIG" | jq -r '.postgresDb')
  DATABASE_URL="postgres://$PG_USER:$PG_PASSWORD@$PG_HOST:$PG_PORT/$PG_DB?sslmode=disable" DBMATE_MIGRATIONS_DIR="./migrations" DBMATE_SCHEMA_FILE="./db/schema.sql" dbmate migrate
"""
description = "Run database migrations (common task)"

[tasks.dbmate]
run = """
  CONFIG=$(bun src/config.ts)
  PG_HOST=$(echo "$CONFIG" | jq -r '.postgresHost')
  PG_PORT=$(echo "$CONFIG" | jq -r '.postgresPort')
  PG_USER=$(echo "$CONFIG" | jq -r '.postgresUser')
  PG_PASSWORD=$(echo "$CONFIG" | jq -r '.postgresPassword')
  PG_DB=$(echo "$CONFIG" | jq -r '.postgresDb')
  DATABASE_URL="postgres://$PG_USER:$PG_PASSWORD@$PG_HOST:$PG_PORT/$PG_DB?sslmode=disable" DBMATE_MIGRATIONS_DIR="./migrations" DBMATE_SCHEMA_FILE="./db/schema.sql" dbmate "$@"
"""
description = "Run dbmate commands (new, rollback, status, dump, etc.)"

[tasks."db:psql"]
run = """
  CONFIG=$(bun src/config.ts)
  PG_HOST=$(echo "$CONFIG" | jq -r '.postgresHost')
  PG_PORT=$(echo "$CONFIG" | jq -r '.postgresPort')
  PG_USER=$(echo "$CONFIG" | jq -r '.postgresUser')
  PG_PASSWORD=$(echo "$CONFIG" | jq -r '.postgresPassword')
  PG_DB=$(echo "$CONFIG" | jq -r '.postgresDb')
  PGPASSWORD="$PG_PASSWORD" psql -h "$PG_HOST" -p "$PG_PORT" -U "$PG_USER" -d "$PG_DB"
"""
description = "Open PostgreSQL shell"

[tasks."db:logs"]
run = "docker compose logs -f postgres"
description = "View PostgreSQL container logs"

[tasks.check]
run = """
  echo "Running Biome checks..."
  bun biome check src/ pulumi/
  echo "Running TypeScript checks..."
  bun tsc --noEmit
"""
description = "Check code formatting, linting, and types"

[tasks.check-fix]
run = """
  echo "Running Biome fixes..."
  bun biome check --write src/ pulumi/
  echo "Running TypeScript checks..."
  bun tsc --noEmit
"""
description = "Auto-fix formatting and linting issues, then check types"

[tasks."db:test:create"]
run = """
  CONFIG=$(bun src/config.ts)
  PG_HOST=$(echo "$CONFIG" | jq -r '.postgresHost')
  PG_PORT=$(echo "$CONFIG" | jq -r '.postgresPort')
  PG_USER=$(echo "$CONFIG" | jq -r '.postgresUser')
  PG_DB_TEST=$(echo "$CONFIG" | jq -r '.postgresDbTest')
  export PGPASSWORD=$(echo "$CONFIG" | jq -r '.postgresPassword')

  # Safety check: only allow dropping databases ending in _test
  if [[ ! "$PG_DB_TEST" =~ _test$ ]]; then
    echo "ERROR: Refusing to drop database '$PG_DB_TEST' - must end with '_test' for safety"
    exit 1
  fi

  PSQL_CMD="psql -h $PG_HOST -p $PG_PORT -U $PG_USER -d postgres"
  # Drop database if exists, then create fresh
  $PSQL_CMD -c "DROP DATABASE IF EXISTS $PG_DB_TEST"
  $PSQL_CMD -c "CREATE DATABASE $PG_DB_TEST"
"""
description = "Drop and recreate test database (ensures clean state)"
depends = ["deps:up"]

[tasks."db:test:migrate"]
run = """
  CONFIG=$(bun src/config.ts)
  PG_HOST=$(echo "$CONFIG" | jq -r '.postgresHost')
  PG_PORT=$(echo "$CONFIG" | jq -r '.postgresPort')
  PG_USER=$(echo "$CONFIG" | jq -r '.postgresUser')
  PG_PASSWORD=$(echo "$CONFIG" | jq -r '.postgresPassword')
  PG_DB_TEST=$(echo "$CONFIG" | jq -r '.postgresDbTest')
  DATABASE_URL="postgres://$PG_USER:$PG_PASSWORD@$PG_HOST:$PG_PORT/$PG_DB_TEST?sslmode=disable" DBMATE_MIGRATIONS_DIR="./migrations" DBMATE_NO_DUMP_SCHEMA=true dbmate migrate
"""
description = "Run migrations on test database"
depends = ["db:test:create"]

[tasks."s3:setup"]
run = """
  CONFIG=$(bun src/config.ts)
  S3_BUCKET=$(echo "$CONFIG" | jq -r '.s3BucketName')
  S3_ACCESS_KEY=$(echo "$CONFIG" | jq -r '.s3AccessKeyId')
  S3_SECRET_KEY=$(echo "$CONFIG" | jq -r '.s3SecretAccessKey')

  # Configure MinIO client and create dev bucket
  docker exec csheet_minio mc alias set myminio http://localhost:9000 "$S3_ACCESS_KEY" "$S3_SECRET_KEY" || true
  docker exec csheet_minio mc mb "myminio/$S3_BUCKET" --ignore-existing || true
"""
description = "Create S3 dev bucket in MinIO"
depends = ["deps:up"]

[tasks."s3:test:setup"]
run = """
  CONFIG=$(bun src/config.ts)
  S3_BUCKET_TEST=$(echo "$CONFIG" | jq -r '.s3BucketNameTest')
  S3_ACCESS_KEY=$(echo "$CONFIG" | jq -r '.s3AccessKeyId')
  S3_SECRET_KEY=$(echo "$CONFIG" | jq -r '.s3SecretAccessKey')

  # Configure MinIO client and create test bucket
  docker exec csheet_minio mc alias set myminio http://localhost:9000 "$S3_ACCESS_KEY" "$S3_SECRET_KEY" || true
  docker exec csheet_minio mc mb "myminio/$S3_BUCKET_TEST" --ignore-existing || true
"""
description = "Create S3 test bucket in MinIO"
depends = ["deps:up"]

[tasks.test]
run = """
  CONFIG=$(bun src/config.ts)
  PG_DB_TEST=$(echo "$CONFIG" | jq -r '.postgresDbTest')
  S3_BUCKET_TEST=$(echo "$CONFIG" | jq -r '.s3BucketNameTest')
  export POSTGRES_DB="$PG_DB_TEST"
  export S3_BUCKET_NAME="$S3_BUCKET_TEST"
  export NODE_ENV="test"
  bun test --randomize --only-failures "$@"
"""
description = "Run tests (pass through arguments to bun test)"
depends = ["db:test:migrate", "s3:test:setup"]
