[tools]
bun = "latest"
jj = "latest"
dbmate = "latest"
jq = "latest"

[env]
# Optional: Set default port
PORT = "3000"

[tasks.dev]
run = "bun run --watch main.ts"
description = "Start development server with hot reload"
depends = ["db:up"]

[tasks.start]
run = "bun run main.tsx"
description = "Start production server"

[tasks.install]
run = "bun install"
description = "Install dependencies"

[tasks."db:up"]
run = "docker compose up --detach --wait"
description = "Start PostgreSQL database in Docker"

[tasks."db:down"]
run = "docker compose down"
description = "Stop PostgreSQL database"

[tasks."db:upgrade"]
run = """
  CONFIG=$(bun src/config.ts)
  PG_HOST=$(echo "$CONFIG" | jq -r '.postgresHost')
  PG_PORT=$(echo "$CONFIG" | jq -r '.postgresPort')
  PG_USER=$(echo "$CONFIG" | jq -r '.postgresUser')
  PG_PASSWORD=$(echo "$CONFIG" | jq -r '.postgresPassword')
  PG_DB=$(echo "$CONFIG" | jq -r '.postgresDb')
  DATABASE_URL="postgres://$PG_USER:$PG_PASSWORD@$PG_HOST:$PG_PORT/$PG_DB?sslmode=disable" DBMATE_MIGRATIONS_DIR="./migrations" DBMATE_SCHEMA_FILE="./db/schema.sql" dbmate migrate
"""
description = "Run database migrations (common task)"

[tasks.dbmate]
run = """
  CONFIG=$(bun src/config.ts)
  PG_HOST=$(echo "$CONFIG" | jq -r '.postgresHost')
  PG_PORT=$(echo "$CONFIG" | jq -r '.postgresPort')
  PG_USER=$(echo "$CONFIG" | jq -r '.postgresUser')
  PG_PASSWORD=$(echo "$CONFIG" | jq -r '.postgresPassword')
  PG_DB=$(echo "$CONFIG" | jq -r '.postgresDb')
  DATABASE_URL="postgres://$PG_USER:$PG_PASSWORD@$PG_HOST:$PG_PORT/$PG_DB?sslmode=disable" DBMATE_MIGRATIONS_DIR="./migrations" DBMATE_SCHEMA_FILE="./db/schema.sql" dbmate "$@"
"""
description = "Run dbmate commands (new, rollback, status, dump, etc.)"

[tasks."db:psql"]
run = """
  CONFIG=$(bun src/config.ts)
  PG_HOST=$(echo "$CONFIG" | jq -r '.postgresHost')
  PG_PORT=$(echo "$CONFIG" | jq -r '.postgresPort')
  PG_USER=$(echo "$CONFIG" | jq -r '.postgresUser')
  PG_PASSWORD=$(echo "$CONFIG" | jq -r '.postgresPassword')
  PG_DB=$(echo "$CONFIG" | jq -r '.postgresDb')
  PGPASSWORD="$PG_PASSWORD" psql -h "$PG_HOST" -p "$PG_PORT" -U "$PG_USER" -d "$PG_DB"
"""
description = "Open PostgreSQL shell"

[tasks."db:logs"]
run = "docker compose logs -f postgres"
description = "View PostgreSQL container logs"

[tasks.check]
run = """
  echo "Running Biome checks..."
  bun biome check src/
  echo "Running TypeScript checks..."
  bun tsc --noEmit
"""
description = "Check code formatting, linting, and types"

[tasks.check-fix]
run = """
  echo "Running Biome fixes..."
  bun biome check --write src/
  echo "Running TypeScript checks..."
  bun tsc --noEmit
"""
description = "Auto-fix formatting and linting issues, then check types"

[tasks."db:test:create"]
run = """
  CONFIG=$(bun src/config.ts)
  PG_HOST=$(echo "$CONFIG" | jq -r '.postgresHost')
  PG_PORT=$(echo "$CONFIG" | jq -r '.postgresPort')
  PG_USER=$(echo "$CONFIG" | jq -r '.postgresUser')
  PG_DB_TEST=$(echo "$CONFIG" | jq -r '.postgresDbTest')
  export PGPASSWORD=$(echo "$CONFIG" | jq -r '.postgresPassword')
  PSQL_CMD="psql -h $PG_HOST -p $PG_PORT -U $PG_USER -d postgres"
  $PSQL_CMD -tc "SELECT 1 FROM pg_database WHERE datname = '$PG_DB_TEST'" | grep -q 1 || $PSQL_CMD -c "CREATE DATABASE $PG_DB_TEST"
"""
description = "Create test database if it doesn't exist"
depends = ["db:up"]

[tasks."db:test:migrate"]
run = """
  CONFIG=$(bun src/config.ts)
  PG_HOST=$(echo "$CONFIG" | jq -r '.postgresHost')
  PG_PORT=$(echo "$CONFIG" | jq -r '.postgresPort')
  PG_USER=$(echo "$CONFIG" | jq -r '.postgresUser')
  PG_PASSWORD=$(echo "$CONFIG" | jq -r '.postgresPassword')
  PG_DB_TEST=$(echo "$CONFIG" | jq -r '.postgresDbTest')
  DATABASE_URL="postgres://$PG_USER:$PG_PASSWORD@$PG_HOST:$PG_PORT/$PG_DB_TEST?sslmode=disable" DBMATE_MIGRATIONS_DIR="./migrations" DBMATE_SCHEMA_FILE="./db/schema.sql" dbmate migrate
"""
description = "Run migrations on test database"
depends = ["db:test:create"]

[tasks.test]
run = """
  CONFIG=$(bun src/config.ts)
  PG_DB_TEST=$(echo "$CONFIG" | jq -r '.postgresDbTest')
  export POSTGRES_DB="$PG_DB_TEST"
  bun test "$@"
"""
description = "Run tests (pass through arguments to bun test)"
depends = ["db:test:migrate"]
