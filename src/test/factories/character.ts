import { faker } from "@faker-js/faker"
import type { Character, CreateCharacter } from "@src/db/characters"
import { create as createCharacter } from "@src/db/characters"
import type { SQL } from "bun"
import { Factory } from "fishery"

interface CharacterFactoryParams {
  user_id?: string
  name?: string
  race?: string
  subrace?: string | null
  background?: string
  alignment?: string | null
  ruleset?: "srd51" | "srd52"
}

const races = [
  "Human",
  "Elf",
  "Dwarf",
  "Halfling",
  "Dragonborn",
  "Gnome",
  "Half-Elf",
  "Half-Orc",
  "Tiefling",
]
const backgrounds = [
  "Acolyte",
  "Criminal",
  "Folk Hero",
  "Noble",
  "Sage",
  "Soldier",
  "Urchin",
  "Entertainer",
]
const alignments = [
  "Lawful Good",
  "Neutral Good",
  "Chaotic Good",
  "Lawful Neutral",
  "True Neutral",
  "Chaotic Neutral",
  "Lawful Evil",
  "Neutral Evil",
  "Chaotic Evil",
]

/**
 * Factory for building test character data
 */
const factory = Factory.define<Character, CharacterFactoryParams>(({ params }) => ({
  id: "", // Will be generated by the database
  user_id: params.user_id ?? "", // Required - will throw error if not provided
  name: params.name ?? faker.person.firstName(),
  race: params.race ?? faker.helpers.arrayElement(races),
  subrace: params.subrace === undefined ? null : params.subrace,
  background: params.background ?? faker.helpers.arrayElement(backgrounds),
  alignment:
    params.alignment === undefined ? faker.helpers.arrayElement(alignments) : params.alignment,
  ruleset: params.ruleset ?? "srd51",
  created_at: new Date(),
  updated_at: new Date(),
}))

/**
 * Create a test character in the database
 * Usage:
 *   const character = await characterFactory.create({ user_id: user.id }, testCtx.db)
 *   const character = await characterFactory.create({ user_id: user.id, name: 'Aragorn' }, testCtx.db)
 */
export const characterFactory = {
  build: factory.build.bind(factory),
  create: async (params: Partial<CharacterFactoryParams>, db: SQL): Promise<Character> => {
    const built = factory.build(params)

    if (!built.user_id) {
      throw new Error("user_id is required to create a character")
    }

    const characterData: CreateCharacter = {
      user_id: built.user_id,
      name: built.name,
      race: built.race,
      subrace: built.subrace,
      background: built.background,
      alignment: built.alignment,
      ruleset: built.ruleset,
    }

    return await createCharacter(db, characterData)
  },
}
